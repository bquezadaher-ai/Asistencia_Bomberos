<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aforo por Cuartel â€“ Bomberos</title>
<style>
  :root{ --bg:#0b1020; --card:#111735; --ink:#e9ecff; --muted:#9aa3c7; --accent:#36d399; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(120deg,#0b1020,#0e1430); color:var(--ink);}
  .wrap{max-width:1100px; margin:40px auto; padding:0 16px;}
  h1{font-size:clamp(22px,3.5vw,34px); margin:0 0 8px}
  .sub{color:var(--muted); margin:0 0 24px}
  .grid{display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:16px;}
  .card{background:var(--card); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
  .head{display:flex; align-items:center; gap:14px; margin-bottom:8px}
  .label{color:var(--muted); font-size:14px; margin-bottom:2px}
  .value{font-size:48px; font-weight:800; line-height:1; margin-bottom:4px}
  .name{font-size:14px; opacity:.9}
  .ok{color:var(--accent)}
  .footer{margin-top:18px; color:var(--muted); font-size:14px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0 20px}
  button{background:var(--accent); color:#0b1020; border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer}
  .led{width:10px; height:10px; border-radius:999px; background:#555}
  .led.ok{background:#36d399}
  .led.bad{background:#ef4444}
  .logo-cuarto{ flex:0 0 auto; width:64px; height:64px; object-fit:contain; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,.25); }

  .countline{display:flex; align-items:flex-end; gap:12px; margin-bottom:10px}
  .panel{ margin-top:10px; }
  .panel label{ display:block; font-size:13px; color:var(--muted); margin:8px 0 4px; }
  .panel select{ width:100%; padding:8px; border-radius:8px; border:1px solid #2a356a; background:#0f1633; color:var(--ink); }
  .panel .multi{ height:50px; }

  /* Chips (etiquetas de unidades presentes) */
  .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
  .chip{ background:#0f1633; border:1px solid #2a356a; color:var(--ink); padding:4px 10px; border-radius:9999px; font-size:12px; }
  .chip .dot{ width:8px; height:8px; background:var(--accent); border-radius:9999px; display:inline-block; margin-right:6px; vertical-align:middle; }
  .small{ font-size:12px; color:var(--muted); margin-top:6px; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Aforo en tiempo real</h1>

    <div class="row">
      <button id="refreshBtn">Actualizar ahora</button>
      <span id="status" class="sub">Esperando datosâ€¦</span>
      <span id="led" class="led"></span>
    </div>

    <div class="grid">
      <!-- Cuartel 1 -->
      <div class="card" id="card-c1">
        <div class="head">
          <img src="img/logocuerpo.png" alt="Cuartel 1" class="logo-cuarto">
          <div>
            <div class="label">Cuartel 1</div>
            <div class="countline">
              <div id="c1" class="value">0</div>
              <div class="name">Personal en Guardia</div>
            </div>
            <div id="chips-1" class="chips"></div>
          </div>
        </div>

        <div class="panel">
          <label>Cuartelero en servicio</label>
          <select id="cuartelero-1"></select>

          <label>Conductor en servicio</label>
          <select id="conductor-1"></select>

          <label>Unidades presentes (multi)</label>
          <select id="unidades-1" class="multi" multiple></select>

          <div class="row" style="margin-top:10px">
            <button onclick="guardarEstado('Cuartel 1')">Guardar Cuartel 1</button>
            <button onclick="limpiarSeleccion('Cuartel 1')">Limpiar</button>
          </div>
          <div class="small" id="saved-1">â€”</div>
        </div>
      </div>

      <!-- Cuartel 2 -->
      <div class="card" id="card-c2">
        <div class="head">
          <img src="img/logocuerpo.png" alt="Cuartel 2" class="logo-cuarto">
          <div>
            <div class="label">Cuartel 2</div>
            <div class="countline">
              <div id="c2" class="value">0</div>
              <div class="name">Personal en Guardia</div>
            </div>
            <div id="chips-2" class="chips"></div>
          </div>
        </div>

        <div class="panel">
          <label>Cuartelero en servicio</label>
          <select id="cuartelero-2"></select>

          <label>Conductor en servicio</label>
          <select id="conductor-2"></select>

          <label>Unidades presentes (multi)</label>
          <select id="unidades-2" class="multi" multiple></select>

          <div class="row" style="margin-top:10px">
            <button onclick="guardarEstado('Cuartel 2')">Guardar Cuartel 2</button>
            <button onclick="limpiarSeleccion('Cuartel 2')">Limpiar</button>
          </div>
          <div class="small" id="saved-2">â€”</div>
        </div>
      </div>

      <!-- Cuartel 3 -->
      <div class="card" id="card-c3">
        <div class="head">
          <img src="img/logocuerpo.png" alt="Cuartel 3" class="logo-cuarto">
          <div>
            <div class="label">Cuartel 3</div>
            <div class="countline">
              <div id="c3" class="value">0</div>
              <div class="name">Personal en Guardia</div>
            </div>
            <div id="chips-3" class="chips"></div>
          </div>
        </div>

        <div class="panel">
          <label>Cuartelero en servicio</label>
          <select id="cuartelero-3"></select>

          <label>Conductor en servicio</label>
          <select id="conductor-3"></select>

          <label>Unidades presentes (multi)</label>
          <select id="unidades-3" class="multi" multiple></select>

          <div class="row" style="margin-top:10px">
            <button onclick="guardarEstado('Cuartel 3')">Guardar Cuartel 3</button>
            <button onclick="limpiarSeleccion('Cuartel 3')">Limpiar</button>
          </div>
          <div class="small" id="saved-3">â€”</div>
        </div>
      </div>

      <!-- Total -->
      <div class="card">
        <div class="label">Total en planta</div>
        <div id="tot" class="value ok">0</div>
        <div class="name">Suma de los 3 cuarteles</div>
        <div class="footer" id="updated">Actualizado: â€”</div>
      </div>
    </div>
  </div>

<script>
  // ðŸ‘‰ Cambia por tu URL /exec
  const API_BASE = "https://script.google.com/macros/s/AKfycbwJSPWzcofIs2VzqzdtURLKQ4da8Ua9LA-qFOD4v944ifDiHiSZcCThx4laNOewOTli/exec";
  const REFRESH_MS = 5000;

  const el = {
    c1: document.getElementById('c1'),
    c2: document.getElementById('c2'),
    c3: document.getElementById('c3'),
    tot: document.getElementById('tot'),
    status: document.getElementById('status'),
    updated: document.getElementById('updated'),
    led: document.getElementById('led'),
    btn: document.getElementById('refreshBtn'),
    cu1: document.getElementById('cuartelero-1'),
    co1: document.getElementById('conductor-1'),
    un1: document.getElementById('unidades-1'),
    cu2: document.getElementById('cuartelero-2'),
    co2: document.getElementById('conductor-2'),
    un2: document.getElementById('unidades-2'),
    cu3: document.getElementById('cuartelero-3'),
    co3: document.getElementById('conductor-3'),
    un3: document.getElementById('unidades-3'),
    saved1: document.getElementById('saved-1'),
    saved2: document.getElementById('saved-2'),
    saved3: document.getElementById('saved-3'),
    chips1: document.getElementById('chips-1'),
    chips2: document.getElementById('chips-2'),
    chips3: document.getElementById('chips-3'),
  };

  // Utilidad JSONP
  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data)=>{ resolve(data); try{delete window[cb]}catch{} };
      const s = document.createElement('script');
      s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
      s.onerror = ()=>{ reject(new Error('JSONP error')); };
      document.body.appendChild(s);
      setTimeout(()=>{ try{s.remove()}catch{} }, 12000);
    });
  }

  // Render de chips a la vista
  function renderChips(container, items){
    container.innerHTML = "";
    (items||[]).forEach(txt=>{
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = '<span class="dot"></span>' + txt;
      container.appendChild(chip);
    });
  }

  async function loadAforo(){
    try{
      el.status.textContent = "Actualizandoâ€¦";
      el.led.classList.remove('bad'); el.led.classList.add('ok');
      const data = await jsonp(API_BASE + "?op=aforo");
      const c1 = (data.counts && data.counts["Cuartel 1"]) || 0;
      const c2 = (data.counts && data.counts["Cuartel 2"]) || 0;
      const c3 = (data.counts && data.counts["Cuartel 3"]) || 0;
      const tot = data.total || (c1+c2+c3);
      el.c1.textContent = c1; el.c2.textContent = c2; el.c3.textContent = c3; el.tot.textContent = tot;
      el.updated.textContent = "Actualizado: " + (data.updated || new Date().toLocaleString("es-CL"));
      el.status.textContent = "OK";
    }catch(err){
      console.error(err);
      el.status.textContent = "Error al actualizar";
      el.led.classList.remove('ok'); el.led.classList.add('bad');
    }
  }

  function fillSelect(sel, arr){
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "â€” Seleccionar â€”";
    sel.appendChild(opt0);
    (arr||[]).forEach(v=>{
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      sel.appendChild(o);
    });
  }
  function fillSelectMulti(sel, arr, selectedList){
    sel.innerHTML = "";
    (arr||[]).forEach(v=>{
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      if (selectedList && selectedList.includes(v)) o.selected = true;
      sel.appendChild(o);
    });
  }

  function applyEstado(cuartel, est, selCuartelero, selConductor, selUnidades, lblSaved, chipsBox, allUnits){
    const e = est[cuartel] || {cuartelero:"", conductor:"", unidades:[], updated:""};
    if (e.cuartelero) selCuartelero.value = e.cuartelero;
    if (e.conductor)  selConductor.value  = e.conductor;

    // Rellena multi con todas las unidades marcando las guardadas
    fillSelectMulti(selUnidades, allUnits, e.unidades);

    // Chips visibles
    renderChips(chipsBox, e.unidades);

    lblSaved.textContent = e.updated ? ("Ãšltima actualizaciÃ³n: " + e.updated) : "â€”";
  }

  async function loadCatalogosYEstado(){
    // 1) Bomberos -> listas de cuarteleros y conductores
    const bom = await jsonp(API_BASE + "?op=bomberos");
    const cuarteleros = [], conductores = [];
    Object.values(bom).forEach(b => {
      if (b.cuartelero) cuarteleros.push(b.nombre);
      if (b.conductor)  conductores.push(b.nombre);
    });
    cuarteleros.sort((a,b)=>a.localeCompare(b));
    conductores.sort((a,b)=>a.localeCompare(b));

    // 2) Unidades (global)
    const uni = await jsonp(API_BASE + "?op=unidades");
    const allUnits = uni.unidades || [];

    // 3) Relleno select simples
    fillSelect(el.cu1, cuarteleros); fillSelect(el.co1, conductores);
    fillSelect(el.cu2, cuarteleros); fillSelect(el.co2, conductores);
    fillSelect(el.cu3, cuarteleros); fillSelect(el.co3, conductores);

    // 4) Estado actual (preselecciÃ³n + chips)
    const est = await jsonp(API_BASE + "?op=estado");
    applyEstado("Cuartel 1", est, el.cu1, el.co1, el.un1, el.saved1, el.chips1, allUnits);
    applyEstado("Cuartel 2", est, el.cu2, el.co2, el.un2, el.saved2, el.chips2, allUnits);
    applyEstado("Cuartel 3", est, el.cu3, el.co3, el.un3, el.saved3, el.chips3, allUnits);
  }

  function limpiarSeleccion(cuartel){
    const map = {
      "Cuartel 1": { un: el.un1, chips: el.chips1, lbl: el.saved1 },
      "Cuartel 2": { un: el.un2, chips: el.chips2, lbl: el.saved2 },
      "Cuartel 3": { un: el.un3, chips: el.chips3, lbl: el.saved3 },
    };
    const ref = map[cuartel];
    Array.from(ref.un.options).forEach(op => op.selected = false);
    renderChips(ref.chips, []);
    ref.lbl.textContent = "â€”";
  }

  async function guardarEstado(cuartel){
    const map = {
      "Cuartel 1": { cu: el.cu1, co: el.co1, un: el.un1, lbl: el.saved1, chips: el.chips1 },
      "Cuartel 2": { cu: el.cu2, co: el.co2, un: el.un2, lbl: el.saved2, chips: el.chips2 },
      "Cuartel 3": { cu: el.cu3, co: el.co3, un: el.un3, lbl: el.saved3, chips: el.chips3 },
    };
    const ref = map[cuartel];
    const cuartelero = ref.cu.value || "";
    const conductor  = ref.co.value || "";
    const unidadesList = Array.from(ref.un.selectedOptions).map(o=>o.value);
    const unidadesCSV  = unidadesList.join(",");

    ref.lbl.textContent = "Guardandoâ€¦";
    try{
      const res = await jsonp(API_BASE + "?op=estado_set"
        + "&cuartel="   + encodeURIComponent(cuartel)
        + "&cuartelero="+ encodeURIComponent(cuartelero)
        + "&conductor=" + encodeURIComponent(conductor)
        + "&unidades="  + encodeURIComponent(unidadesCSV)
      );
      if (res && res.ok){
        ref.lbl.textContent = "Guardado: " + (res.updated || "");
        renderChips(ref.chips, unidadesList); // refresca etiquetas visibles
      } else {
        ref.lbl.textContent = "Error al guardar";
      }
    }catch(err){
      console.error(err);
      ref.lbl.textContent = "Error al guardar";
    }
  }

  // Init
  el.btn.addEventListener('click', loadAforo);
  (async function init(){
    await loadCatalogosYEstado();
    await loadAforo();
    setInterval(loadAforo, REFRESH_MS);
  })();
</script>
</body>
</html>
