<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lector QR – Cuartel 2</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1020;color:#e9ecff}
.wrap{max-width:900px;margin:24px auto;padding:0 16px}
h1{margin:8px 0 4px}.sub{color:#9aa3c7;margin:0 0 16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
button{background:#36d399;color:#0b1020;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-alt{background:#1f2b63;color:#e9ecff}
.pill{border:1px solid #2a356a;background:#0f1633;border-radius:999px;padding:6px 10px;cursor:pointer}
.active{outline:2px solid #36d399}
#reader{width:100%;max-width:520px;aspect-ratio:3/4;background:#000;border-radius:12px;overflow:hidden}
.log{background:#0f1633;border:1px solid #2a356a;border-radius:10px;padding:10px;min-height:56px}
.ok{color:#36d399}.bad{color:#ef4444}
.frase{margin-top:6px;color:#cfe7ff}
</style>
</head>
<body>
<div class="wrap">
  <h1>Lector QR – Cuartel 2</h1>
  <p class="sub">Escanea un QR. Se pronuncia la frase personalizada y se registra Entrada/Salida en este cuartel.</p>

  <div class="row">
    <span>Motivo:</span>
    <span class="pill active" data-m="Guardia">Guardia</span>
    <span class="pill" data-m="Academia">Academia</span>
    <span class="pill" data-m="Curso">Curso</span>
    <span class="pill" data-m="Reunión">Reunión</span>
    <span class="pill" data-m="Visita">Visita</span>
  </div>

  <div id="reader"></div>

  <div class="row" style="margin-top:12px">
    <button id="startBtn">Iniciar cámara</button>
    <button id="stopBtn" class="btn-alt">Detener</button>
    <button id="switchBtn" class="btn-alt">Cambiar</button>
  </div>

  <div class="log" id="log">Listo.</div>
  <div class="frase" id="frase">—</div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== Configura esto ===== */
const CUARTEL_NAME = "Cuartel 2";
const API_BASE = "https://script.google.com/macros/s/AKfycbzGR_re4fwu4XY4ufVgr6ReXkYaAc4EtwBByepe_1T-Cl6xltk28g-MkvRWVR4i-Enj/exec";  // ← REEMPLAZA por tu /exec
const SCAN_COOLDOWN_MS = 5000;
/* ========================== */

const logEl = document.getElementById('log');
const fraseEl = document.getElementById('frase');
let currentMotivo = "Guardia";
document.querySelectorAll('.pill').forEach(p=>{
  p.addEventListener('click', ()=>{
    document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
    p.classList.add('active');
    currentMotivo = p.dataset.m;
  });
});

// JSONP helper
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=d=>{ resolve(d); try{ delete window[cb] }catch{} };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+"callback="+cb+"&_="+Date.now();
    s.onerror=()=>reject(new Error("JSONP error"));
    document.body.appendChild(s);
    setTimeout(()=>{ try{s.remove()}catch{} }, 12000);
  });
}

// Voz
function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text);
    u.lang="es-CL";
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch{}
}

// Envío sin CORS
async function sendBeacon(url){
  try{
    await fetch(url, { mode:"no-cors", cache:"no-store" });
    return true;
  }catch{
    return await new Promise(res=>{
      const img = new Image();
      img.onload = ()=>res(true);
      img.onerror= ()=>res(false);
      img.src = url + (url.includes('?')?'&':'?') + "_=" + Date.now();
      setTimeout(()=>res(true), 1500);
    });
  }
}

// Antirréplica
const lastScanAt = new Map();
function canAccept(id){
  const t=Date.now(), last=lastScanAt.get(id)||0;
  if (t-last < SCAN_COOLDOWN_MS) return false;
  lastScanAt.set(id,t);
  return true;
}

// Extraer ID del QR (texto simple o JSON {id:"..."})
function extractIdFromQr(text){
  try{
    const obj = JSON.parse(text);
    if (obj && obj.id) return String(obj.id).trim().toUpperCase();
  }catch{}
  return String(text||"").trim().toUpperCase();
}

// Flujo principal: consulta próxima acción + frase → habla → registra
async function registrarPorId(idPlano, motivoSel){
  const id = (idPlano||"").trim().toUpperCase();
  const motivo = motivoSel || "Guardia";
  if (!id){ logEl.textContent="ID vacío"; return; }

  try{
    logEl.textContent = "Consultando acción…";
    fraseEl.textContent = "—";
    const next = await jsonp(
      API_BASE + "?op=next&id=" + encodeURIComponent(id) + "&cuartel=" + encodeURIComponent(CUARTEL_NAME)
    );
    if (!next || !next.ok){
      logEl.innerHTML = '<span class="bad">Error al obtener acción</span>';
      return;
    }

    // Frase personalizada
    if (next.frase){
      fraseEl.textContent = next.frase;
      speak(next.frase);
    } else {
      fraseEl.textContent = "—";
    }

    // Registrar con acción explícita (Entrada/Salida)
    const url = API_BASE
      + "?id="      + encodeURIComponent(id)
      + "&nombre="  + encodeURIComponent(next.nombre || "")
      + "&cargo="   + encodeURIComponent(next.cargo  || "")
      + "&cuartel=" + encodeURIComponent(CUARTEL_NAME)
      + "&accion="  + encodeURIComponent(next.accion)
      + "&motivo="  + encodeURIComponent(motivo);

    logEl.textContent = "Registrando " + next.accion + "…";
    const ok = await sendBeacon(url);
    logEl.innerHTML = ok
      ? `<span class="ok">OK: ${next.accion} para ${next.nombre||id}</span>`
      : `<span class="bad">Error al registrar</span>`;
  }catch(e){
    console.error(e);
    logEl.innerHTML = '<span class="bad">Error de red</span>';
  }
}

// Cámara (html5-qrcode)
const html5QrCode = new Html5Qrcode("reader");
let currentCameraId = null;

async function startCamera(){
  logEl.textContent="Solicitando cámara…";
  const devices = await Html5Qrcode.getCameras();
  if (!devices || !devices.length){
    logEl.innerHTML='<span class="bad">No hay cámaras</span>'; return;
  }
  currentCameraId = currentCameraId || (devices.find(d=>/back|rear|environment/i.test(d.label))?.id || devices[0].id);
  await html5QrCode.start(
    { deviceId: { exact: currentCameraId } },
    { fps: 10, qrbox: { width: 300, height: 300 } },
    onScanSuccess,
    onScanError
  );
  logEl.textContent="Cámara activa. Escanea un QR.";
}
async function stopCamera(){ try{ await html5QrCode.stop(); logEl.textContent="Cámara detenida."; }catch{} }
async function switchCamera(){
  try{
    const devices = await Html5Qrcode.getCameras();
    if (!devices || devices.length<2){ logEl.textContent="No hay otra cámara"; return; }
    const idx = devices.findIndex(d=>d.id===currentCameraId);
    const next = devices[(idx+1)%devices.length];
    await html5QrCode.stop();
    currentCameraId = next.id;
    await startCamera();
  }catch(e){ console.error(e); }
}

function onScanSuccess(decodedText){
  const id = extractIdFromQr(decodedText);
  if(!id){ logEl.innerHTML='<span class="bad">QR sin ID</span>'; return; }
  if(!canAccept(id)) return;     // evita duplicados instantáneos
  registrarPorId(id, currentMotivo);
}
function onScanError(){ /* ignorar ruidos */ }

// Botones
document.getElementById('startBtn').addEventListener('click', startCamera);
document.getElementById('stopBtn').addEventListener('click', stopCamera);
document.getElementById('switchBtn').addEventListener('click', switchCamera);
</script>
</body>
</html>
