<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Asistencia Bomberos</title>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#0b1020; color:#e9ecff; text-align:center; }
    .card { background:#111735; padding:20px; margin:20px auto; border-radius:12px; max-width:700px; }
    h2 { color:#36d399; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Registro de asistencia</h2>
    <div id="reader" style="width:500px;margin:auto;"></div>
    <p id="result"></p>
    <h3 id="contador"></h3>
  </div>

  <script>
    // ðŸ‘‰ CAMBIA ESTE LINK POR EL DE TU APP SCRIPT
    const API_URL = "https://script.google.com/macros/s/AKfycbwAa7ibhxR3f7f99QRruZICTb1c20t_1N1xQfHv8fFY6Jj-CaMAgufBHJdSB2DyUnEj/exec";

    // ðŸ”¹ Lista de bomberos (ejemplo, agrega los tuyos)
    let registros = {};
    let bomberos = {
      "B001": { nombre:"Bryan Quezada", cargo:"Voluntario", cuartel:"Cuartel 1" },
      "B002": { nombre:"Leonardo FrÃ­as", cargo:"Teniente Segundo", cuartel:"Cuartel 2" },
      "B003": { nombre:"Diego PÃ©rez", cargo:"Voluntario", cuartel:"Cuartel 3" }
    };

    function hablar(texto){
      let voz = new SpeechSynthesisUtterance(texto);
      voz.lang = "es-CL";
      speechSynthesis.speak(voz);
    }

    function actualizarContador(){
      let cuartel1 = Object.values(registros).filter(r => r.estado==="dentro" && r.cuartel==="Cuartel 1").length;
      let cuartel2 = Object.values(registros).filter(r => r.estado==="dentro" && r.cuartel==="Cuartel 2").length;
      let cuartel3 = Object.values(registros).filter(r => r.estado==="dentro" && r.cuartel==="Cuartel 3").length;
      let total = cuartel1 + cuartel2 + cuartel3;

      document.getElementById("contador").innerHTML = `
        ðŸš’ Cuartel 1: ${cuartel1}<br>
        ðŸš’ Cuartel 2: ${cuartel2}<br>
        ðŸš’ Cuartel 3: ${cuartel3}<br>
        ðŸ”¥ Total en planta: ${total}
      `;
    }

    function guardarEnSheets(id, nombre, cargo, cuartel, accion) {
      let url = `${API_URL}?id=${encodeURIComponent(id)}&nombre=${encodeURIComponent(nombre)}&cargo=${encodeURIComponent(cargo)}&cuartel=${encodeURIComponent(cuartel)}&accion=${encodeURIComponent(accion)}`;
      fetch(url).then(r => r.text()).then(data => console.log("Guardado en Sheets:", data))
               .catch(err => console.error("Error:", err));
    }

    function onScanSuccess(decodedText) {
      let id = decodedText;
      let bombero = bomberos[id];
      if (!bombero) {
        document.getElementById("result").innerText = "QR no vÃ¡lido";
        return;
      }

      let accion;
      if (!registros[id] || registros[id].estado === "fuera") {
        registros[id] = {estado: "dentro", entrada: new Date(), cuartel: bombero.cuartel};
        accion = "Entrada";
        hablar("Bienvenido " + bombero.cargo + " " + bombero.nombre + " al " + bombero.cuartel);
      } else {
        registros[id] = {estado: "fuera", salida: new Date(), cuartel: bombero.cuartel};
        accion = "Salida";
        hablar("AdiÃ³s " + bombero.cargo + " " + bombero.nombre + " del " + bombero.cuartel);
      }

      document.getElementById("result").innerText = `${bombero.nombre} (${bombero.cuartel}) - ${accion} a las ${new Date().toLocaleTimeString()}`;
      actualizarContador();
      guardarEnSheets(id, bombero.nombre, bombero.cargo, bombero.cuartel, accion);
    }

    new Html5QrcodeScanner("reader", { fps: 10, qrbox: 300 })
      .render(onScanSuccess);
  </script>
</body>
</html>

