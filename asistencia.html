<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Asistencia Bomberos</title>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#0b1020; color:#e9ecff; text-align:center; }
    .card { background:#111735; padding:20px; margin:20px auto; border-radius:12px; max-width:700px; }
    h2 { color:#36d399; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Registro de asistencia</h2>
    <div id="reader" style="width:500px;margin:auto;"></div>
    <p id="result"></p>
    <h3 id="contador"></h3>
  </div>

  <script>
    // ðŸ‘‰ Pega aquÃ­ tu URL del Apps Script (termina en /exec)
    const API_URL = "https://script.google.com/macros/s/TU_ID/exec";

    // ConfiguraciÃ³n
    const COOLDOWN_MS = 2000; // 2 segundos de espera entre lecturas del mismo QR
    let lastScanId = null;
    let lastScanTime = 0;

    // Datos de ejemplo (agrega todos tus bomberos aquÃ­)
    let registros = {};
    let bomberos = {
      "B001": { nombre:"Bryan Quezada", cargo:"Voluntario", cuartel:"Cuartel 1" },
      "B002": { nombre:"Leonardo FrÃ­as", cargo:"Teniente Segundo", cuartel:"Cuartel 2" },
      "B003": { nombre:"Diego PÃ©rez", cargo:"Voluntario", cuartel:"Cuartel 3" }
    };

    function hablar(texto){
      const voz = new SpeechSynthesisUtterance(texto);
      voz.lang = "es-CL";
      speechSynthesis.speak(voz);
    }

    function actualizarContador(){
      const c = { "Cuartel 1":0, "Cuartel 2":0, "Cuartel 3":0 };
      Object.values(registros).forEach(r => {
        if (r.estado === "dentro") c[r.cuartel] = (c[r.cuartel]||0)+1;
      });
      const total = (c["Cuartel 1"]||0)+(c["Cuartel 2"]||0)+(c["Cuartel 3"]||0);
      document.getElementById("contador").innerHTML =
        `ðŸš’ Cuartel 1: ${c["Cuartel 1"]||0}<br>`+
        `ðŸš’ Cuartel 2: ${c["Cuartel 2"]||0}<br>`+
        `ðŸš’ Cuartel 3: ${c["Cuartel 3"]||0}<br>`+
        `ðŸ”¥ Total en planta: ${total}`;
    }

    function guardarEnSheets(id, nombre, cargo, cuartel, accion) {
      const url = `${API_URL}?id=${encodeURIComponent(id)}&nombre=${encodeURIComponent(nombre)}&cargo=${encodeURIComponent(cargo)}&cuartel=${encodeURIComponent(cuartel)}&accion=${encodeURIComponent(accion)}`;
      fetch(url).then(r => r.text()).then(t => console.log("Sheets:", t)).catch(console.error);
    }

    // âœ… CÃ¡mara siempre activa, con filtro anti-duplicados
    function onScanSuccess(decodedText) {
      const now = Date.now();
      const id = decodedText.trim();

      // Si es el mismo cÃ³digo en menos del cooldown â†’ ignorar
      if (id === lastScanId && (now - lastScanTime) < COOLDOWN_MS) {
        return;
      }

      lastScanId = id;
      lastScanTime = now;

      console.log("QR detectado:", id);

      const bombero = bomberos[id];
      if (!bombero) {
        document.getElementById("result").innerText = "QR no vÃ¡lido";
        return;
      }

      let accion;
      if (!registros[id] || registros[id].estado === "fuera") {
        registros[id] = { estado:"dentro", entrada:new Date(), cuartel:bombero.cuartel };
        accion = "Entrada";
        hablar(`Bienvenido ${bombero.cargo} ${bombero.nombre} al ${bombero.cuartel}`);
      } else {
        registros[id] = { estado:"fuera", salida:new Date(), cuartel:bombero.cuartel };
        accion = "Salida";
        hablar(`AdiÃ³s ${bombero.cargo} ${bombero.nombre} del ${bombero.cuartel}`);
      }

      document.getElementById("result").innerText =
        `${bombero.nombre} (${bombero.cuartel}) - ${accion} a las ${new Date().toLocaleTimeString()}`;
      actualizarContador();
      guardarEnSheets(id, bombero.nombre, bombero.cargo, bombero.cuartel, accion);
    }

    // Iniciar lector (la cÃ¡mara no se apaga nunca)
    window.addEventListener("load", () => {
      new Html5QrcodeScanner("reader", { fps: 10, qrbox: 300 }).render(onScanSuccess);
    });
  </script>
</body>
</html>
