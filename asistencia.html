<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asistencia Bomberos</title>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#0b1020; color:#e9ecff; text-align:center; }
    .card { background:#111735; padding:20px; margin:20px auto; border-radius:12px; max-width:700px; }
    h2 { color:#36d399; }
    .muted{ color:#9aa3c7; font-size:14px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Registro de asistencia</h2>
    <div class="muted" id="status">Cargando listado de bomberosâ€¦</div>
    <div id="reader" style="width:500px;margin:16px auto;"></div>
    <p id="result"></p>
    <h3 id="contador"></h3>
  </div>

  <script>
    // ðŸ‘‰ Pega AQUÃ tu URL de Apps Script (termina en /exec)
    const BASE_URL = "https://script.google.com/macros/s/AKfycbyQ-DAszNtlH-jEwzcJpKBqr_S2Ne-anWpHVmgz9dqpEleHmLproLJeYEGU6XGkZunK/exec";

    // Config
    const COOLDOWN_MS = 2000;
    let lastScanId = null, lastScanTime = 0;

    // Estado
    let registros = {};
    let bomberos = {}; // lo cargamos desde Sheets

    function hablar(texto){
      const voz = new SpeechSynthesisUtterance(texto);
      voz.lang = "es-CL";
      speechSynthesis.speak(voz);
    }

    function actualizarContador(){
      const c = { "Cuartel 1":0, "Cuartel 2":0, "Cuartel 3":0 };
      Object.values(registros).forEach(r => { if (r.estado==="dentro") c[r.cuartel] = (c[r.cuartel]||0)+1; });
      const total = (c["Cuartel 1"]||0)+(c["Cuartel 2"]||0)+(c["Cuartel 3"]||0);
      document.getElementById("contador").innerHTML =
        `ðŸš’ Cuartel 1: ${c["Cuartel 1"]||0}<br>`+
        `ðŸš’ Cuartel 2: ${c["Cuartel 2"]||0}<br>`+
        `ðŸš’ Cuartel 3: ${c["Cuartel 3"]||0}<br>`+
        `ðŸ”¥ Total en planta: ${total}`;
    }

    function guardarEnSheets(id, nombre, cargo, cuartel, accion) {
      const url = `${BASE_URL}?id=${encodeURIComponent(id)}&nombre=${encodeURIComponent(nombre)}&cargo=${encodeURIComponent(cargo)}&cuartel=${encodeURIComponent(cuartel)}&accion=${encodeURIComponent(accion)}`;
      fetch(url).then(r => r.text()).then(t => console.log("Sheets:", t)).catch(console.error);
    }

    function fraseBienvenida(b){
      // Si en la hoja hay frase personalizada, Ãºsala
      if (b.bienvenida && b.bienvenida.trim()!=="") return b.bienvenida;
      // Si no, frase por defecto
      return `Bienvenido ${b.cargo} ${b.nombre} al ${b.cuartel}`;
    }
    function fraseDespedida(b){
      if (b.despedida && b.despedida.trim()!=="") return b.despedida;
      return `AdiÃ³s ${b.cargo} ${b.nombre} del ${b.cuartel}`;
    }

    // CÃ¡mara activa + filtro anti-duplicados
    function onScanSuccess(decodedText) {
      const now = Date.now();
      const id = decodedText.trim();
      if (id === lastScanId && (now - lastScanTime) < COOLDOWN_MS) return;
      lastScanId = id; lastScanTime = now;

      const b = bomberos[id];
      if (!b) {
        document.getElementById("result").innerText = "QR no vÃ¡lido";
        return;
      }

      let accion;
      if (!registros[id] || registros[id].estado === "fuera") {
        registros[id] = { estado:"dentro", entrada:new Date(), cuartel:b.cuartel };
        accion = "Entrada";
        hablar(fraseBienvenida(b));
      } else {
        registros[id] = { estado:"fuera", salida:new Date(), cuartel:b.cuartel };
        accion = "Salida";
        hablar(fraseDespedida(b));
      }

      document.getElementById("result").innerText =
        `${b.nombre} (${b.cuartel}) - ${accion} a las ${new Date().toLocaleTimeString()}`;
      actualizarContador();
      guardarEnSheets(id, b.nombre, b.cargo, b.cuartel, accion);
    }

    // Carga el maestro de bomberos desde la hoja (op=bomberos)
    async function cargarBomberos(){
      const status = document.getElementById("status");
      status.textContent = "Cargando listado de bomberosâ€¦";
      try {
        // Leemos como texto y parseamos, por si GAS sirve text/plain
        const res = await fetch(`${BASE_URL}?op=bomberos`, { cache: "no-store" });
        const txt = await res.text();
        console.log("Bomberos (raw):", txt);
        bomberos = JSON.parse(txt); // objeto: { "B001": {nombre, cargo, cuartel, ...}, ... }

        const cantidad = Object.keys(bomberos).length;
        status.textContent = `Listado cargado: ${cantidad} bomberos. Escanee un QR.`;

        // Iniciar el lector SOLO cuando ya cargamos el maestro
        new Html5QrcodeScanner("reader", { fps: 10, qrbox: 300 }).render(onScanSuccess);
      } catch (e) {
        console.error(e);
        status.textContent = "Error cargando el listado. Revise la URL del Apps Script.";
      }
    }

    window.addEventListener("load", cargarBomberos);
  </script>
</body>
</html>
